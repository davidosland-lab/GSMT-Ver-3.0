<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Global Markets Tracker - Live Data</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    :root {
      --color-asx200: #8b5cf6;
      --color-asx300: #7c3aed;
      --color-asx50: #a855f7;
      --color-asx100: #6d28d9;
      --color-asx-small: #c084fc;
      --color-nikkei: #2563eb;
      --color-hsi: #f97316;
      --color-sse: #16a34a;
      --color-nifty: #9333ea;
      --color-ftse: #ef4444;
      --color-dax: #0891b2;
      --color-cac: #a16207;
      --color-sp500: #0ea5e9;
      --color-djia: #10b981;
      --color-nasdaq: #e11d48;
    }

    html, body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
    }

    #chart {
      width: 100%;
    }

    .legend-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 9999px;
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="container mx-auto p-4 max-w-7xl">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <h1 class="text-xl font-semibold">Global Markets Tracker <span class="text-green-600">Live</span></h1>
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2" id="apiStatus">
            <span class="text-xs font-medium" id="statusIndicator">ðŸŸ¡ Loading live data...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
        <div class="flex items-center gap-2">
          <label for="modeSelect" class="text-sm text-slate-600">View</label>
          <select id="modeSelect" class="border rounded-md px-2 py-1 text-sm">
            <option value="line">Line (Multi)</option>
            <option value="candle">Candlestick (Single)</option>
          </select>
        </div>
        
        <div class="flex items-center gap-2">
          <label for="intervalSelect" class="text-sm text-slate-600">Interval</label>
          <select id="intervalSelect" class="border rounded-md px-2 py-1 text-sm">
            <option value="5m">5 Minutes</option>
            <option value="15m">15 Minutes</option>
            <option value="30m">30 Minutes</option>
            <option value="1h">1 Hour</option>
            <option value="1d">1 Day</option>
          </select>
        </div>
        
        <div class="flex items-center gap-2">
          <label for="dateSelect" class="text-sm text-slate-600">Date</label>
          <input type="date" id="dateSelect" class="border rounded-md px-2 py-1 text-sm" />
        </div>
        
        <button id="refreshBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
    </div>

    <!-- Index Selection (for multi-line mode) -->
    <div id="indexSelectionWrap" class="bg-white rounded-lg shadow-sm border p-4 mb-6">
      <h3 class="text-sm font-medium text-slate-700 mb-3">Select Markets to Compare (Live Data)</h3>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3" id="indexCheckboxes">
      </div>
    </div>

    <!-- Single Index Selection (for candlestick mode) -->
    <div id="singleIndexWrap" class="bg-white rounded-lg shadow-sm border p-4 mb-6" style="display: none;">
      <h3 class="text-sm font-medium text-slate-700 mb-3">Select Market for Candlestick View</h3>
      <select id="indexSelect" class="border rounded-md px-2 py-1 text-sm w-full sm:w-auto">
      </select>
    </div>

    <!-- Chart -->
    <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
      <div id="chart" style="height: 600px;"></div>
    </div>

    <!-- Legend -->
    <div class="bg-white rounded-lg shadow-sm border p-4">
      <h3 class="text-sm font-medium text-slate-700 mb-3">Legend</h3>
      <div class="flex flex-wrap gap-3" id="legendList">
      </div>
    </div>
  </div>

  <script>
    // Market Index Definitions
    const INDEX_DEFS = [
      { code: '^AXJO', name: 'ASX 200 (AU)', color: getCSS('--color-asx200'), region: 'Australia' },
      { code: '^AXKO', name: 'ASX 300 (AU)', color: getCSS('--color-asx300'), region: 'Australia' },
      { code: '^AFLI', name: 'ASX 50 (AU)', color: getCSS('--color-asx50'), region: 'Australia' },
      { code: '^AXMD', name: 'ASX 100 (AU)', color: getCSS('--color-asx100'), region: 'Australia' },
      { code: '^AXSO', name: 'ASX Small Cap (AU)', color: getCSS('--color-asx-small'), region: 'Australia' },
      { code: '^N225', name: 'Nikkei 225 (JP)', color: getCSS('--color-nikkei'), region: 'Asia' },
      { code: '^HSI', name: 'Hang Seng (HK)', color: getCSS('--color-hsi'), region: 'Asia' },
      { code: '000001.SS', name: 'SSE Composite (CN)', color: getCSS('--color-sse'), region: 'Asia' },
      { code: '^NSEI', name: 'NIFTY 50 (IN)', color: getCSS('--color-nifty'), region: 'Asia' },
      { code: '^FTSE', name: 'FTSE 100 (UK)', color: getCSS('--color-ftse'), region: 'Europe' },
      { code: '^GDAXI', name: 'DAX (DE)', color: getCSS('--color-dax'), region: 'Europe' },
      { code: '^FCHI', name: 'CAC 40 (FR)', color: getCSS('--color-cac'), region: 'Europe' },
      { code: '^GSPC', name: 'S&P 500 (US)', color: getCSS('--color-sp500'), region: 'Americas' },
      { code: '^DJI', name: 'Dow Jones (US)', color: getCSS('--color-djia'), region: 'Americas' },
      { code: '^IXIC', name: 'NASDAQ (US)', color: getCSS('--color-nasdaq'), region: 'Americas' },
    ];

    function getCSS(prop) {
      return getComputedStyle(document.documentElement).getPropertyValue(prop).trim();
    }

    // Live Data Fetching
    async function fetchLiveData(symbol, interval, selectedDate) {
      const API_BASE = window.location.hostname === 'localhost' 
        ? 'http://localhost:5000'
        : 'https://global-indices-tracker-production.up.railway.app';
      
      try {
        console.log(`ðŸ”„ Fetching live data: ${symbol}, ${interval}, ${selectedDate}`);
        
        const response = await fetch(
          `${API_BASE}/api/stock/${encodeURIComponent(symbol)}?interval=${interval}&date=${selectedDate}`,
          {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            }
          }
        );
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const json = await response.json();
        
        if (json.error) {
          throw new Error(json.error);
        }
        
        if (!json.data || json.data.length === 0) {
          throw new Error('No market data available');
        }
        
        console.log(`âœ… Got ${json.data.length} data points from API`);
        
        return json.data.map(item => ({
          time: new Date(item.time),
          open: parseFloat(item.open) || 0,
          high: parseFloat(item.high) || 0,
          low: parseFloat(item.low) || 0,
          close: parseFloat(item.close) || 0,
          value: parseFloat(item.value || item.close) || 0
        }));
        
      } catch (error) {
        console.error('Live data fetch error:', error);
        throw error;
      }
    }

    async function getLiveData(symbol, interval, selectedDate) {
      try { 
        updateApiStatus('ðŸŸ¡ Fetching live data...', 'text-blue-600');
        const data = await fetchLiveData(symbol, interval, selectedDate);
        updateApiStatus('ðŸŸ¢ Live market data', 'text-green-600');
        return data;
      }
      catch(error) { 
        console.error('Live data error:', error);
        updateApiStatus('ðŸ”´ Connection error', 'text-red-600');
        throw error;
      }
    }

    function updateApiStatus(message, colorClass) {
      const indicator = document.getElementById('statusIndicator');
      if (indicator) {
        indicator.textContent = message;
        indicator.className = `text-xs font-medium ${colorClass}`;
      }
    }

    // DOM Elements
    const chart = echarts.init(document.getElementById('chart'));
    const modeSelect = document.getElementById('modeSelect');
    const intervalSelect = document.getElementById('intervalSelect');
    const dateSelect = document.getElementById('dateSelect');
    const indexSelect = document.getElementById('indexSelect');
    const refreshBtn = document.getElementById('refreshBtn');
    const legendList = document.getElementById('legendList');
    const indexSelectionWrap = document.getElementById('indexSelectionWrap');
    const singleIndexWrap = document.getElementById('singleIndexWrap');

    // Set default date
    dateSelect.value = new Date().toISOString().split('T')[0];

    function populateIndexControls() {
      const checkboxContainer = document.getElementById('indexCheckboxes');
      
      INDEX_DEFS.forEach(idx => {
        // Multi-select checkboxes
        const wrapper = document.createElement('div');
        wrapper.className = 'flex items-center space-x-2';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `idx_${idx.code}`;
        checkbox.value = idx.code;
        checkbox.className = 'rounded border-gray-300';
        
        if (['^AXJO', '^GSPC', '^N225'].includes(idx.code)) {
          checkbox.checked = true;
        }
        
        const label = document.createElement('label');
        label.htmlFor = `idx_${idx.code}`;
        label.textContent = idx.name;
        label.className = 'text-sm text-gray-700 cursor-pointer';
        
        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        checkboxContainer.appendChild(wrapper);
        
        // Single select dropdown
        const option = document.createElement('option');
        option.value = idx.code;
        option.textContent = idx.name;
        indexSelect.appendChild(option);
      });
    }

    function getSelectedIndices() {
      const checkboxes = document.querySelectorAll('#indexCheckboxes input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    function toggleMode() {
      const mode = modeSelect.value;
      if (mode === 'line') {
        indexSelectionWrap.style.display = 'block';
        singleIndexWrap.style.display = 'none';
      } else {
        indexSelectionWrap.style.display = 'none';  
        singleIndexWrap.style.display = 'block';
      }
    }

    function buildLineOption(percentSeries, selectedDate) {
      const series = Object.keys(percentSeries).map(code => {
        const idx = INDEX_DEFS.find(i => i.code === code);
        return {
          name: idx ? idx.name : code,
          type: 'line',
          data: percentSeries[code],
          smooth: true,
          lineStyle: { color: idx ? idx.color : '#000', width: 2 },
          itemStyle: { color: idx ? idx.color : '#000' }
        };
      });

      return {
        title: { text: `Global Markets - ${selectedDate}`, left: 'center' },
        tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
        xAxis: { type: 'time', boundaryGap: false },
        yAxis: { type: 'value', name: 'Change (%)' },
        series: series,
        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true }
      };
    }

    // FIXED: Improved candlestick chart function
    function buildCandleOption(data, selectedDate) {
      console.log('Building candlestick chart with data:', data.length, 'points');
      
      if (!data || data.length === 0) {
        return {
          title: { text: 'No data available for candlestick view', left: 'center' },
          series: []
        };
      }

      // Sort data by time to ensure proper order
      const sortedData = data.sort((a, b) => new Date(a.time) - new Date(b.time));
      
      // Format data for candlestick: [open, close, low, high]
      const candleData = sortedData.map(d => {
        const open = parseFloat(d.open) || 0;
        const close = parseFloat(d.close) || 0;
        const low = parseFloat(d.low) || 0;
        const high = parseFloat(d.high) || 0;
        
        // Validate data
        if (isNaN(open) || isNaN(close) || isNaN(low) || isNaN(high)) {
          console.warn('Invalid OHLC data:', d);
          return [0, 0, 0, 0];
        }
        
        return [open, close, low, high];
      });

      // Format time labels
      const timeLabels = sortedData.map(d => {
        const date = new Date(d.time);
        return date.toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: false 
        });
      });

      console.log('Candlestick data prepared:', candleData.length, 'candles');

      return {
        title: { 
          text: `Candlestick Chart - ${selectedDate}`, 
          left: 'center',
          textStyle: { fontSize: 16 }
        },
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'cross' },
          formatter: function (params) {
            const param = params[0];
            if (!param || !param.data) return '';
            
            const [open, close, low, high] = param.data;
            return `
              <div style="font-size: 12px;">
                <strong>${param.name}</strong><br/>
                Open: ${open.toFixed(2)}<br/>
                High: <span style="color: #26a69a;">${high.toFixed(2)}</span><br/>
                Low: <span style="color: #ef5350;">${low.toFixed(2)}</span><br/>
                Close: ${close.toFixed(2)}
              </div>
            `;
          }
        },
        xAxis: {
          type: 'category',
          data: timeLabels,
          boundaryGap: true,
          axisLine: { lineStyle: { color: '#999' } },
          axisTick: { show: true },
          axisLabel: { 
            color: '#666',
            fontSize: 10,
            interval: Math.floor(timeLabels.length / 8) // Show every 8th label
          }
        },
        yAxis: {
          type: 'value',
          scale: true,
          axisLine: { lineStyle: { color: '#999' } },
          axisLabel: { 
            color: '#666',
            fontSize: 10,
            formatter: '{value}'
          },
          splitLine: { 
            lineStyle: { color: '#f0f0f0' }
          }
        },
        series: [{
          name: 'Candlestick',
          type: 'candlestick',
          data: candleData,
          itemStyle: {
            color: '#26a69a',        // Rising color (green)
            color0: '#ef5350',       // Falling color (red)
            borderColor: '#26a69a',  // Rising border
            borderColor0: '#ef5350'  // Falling border
          },
          barWidth: '60%'
        }],
        grid: { 
          left: '8%', 
          right: '8%', 
          top: '15%',
          bottom: '15%', 
          containLabel: true 
        },
        dataZoom: [
          {
            type: 'inside',
            xAxisIndex: 0,
            start: 0,
            end: 100
          },
          {
            show: true,
            xAxisIndex: 0,
            type: 'slider',
            top: '90%',
            start: 0,
            end: 100
          }
        ]
      };
    }

    function updateLegend(activeIndices) {
      legendList.innerHTML = '';
      activeIndices.forEach(idx => {
        const item = document.createElement('div');
        item.className = 'legend-badge';
        item.innerHTML = `<div class="legend-dot" style="background-color: ${idx.color};"></div><span class="text-sm">${idx.name}</span>`;
        legendList.appendChild(item);
      });
    }

    async function render() {
      const mode = modeSelect.value;
      const interval = intervalSelect.value;
      const selectedDate = dateSelect.value;

      if (!selectedDate) return;

      chart.showLoading('default', { maskColor: 'rgba(255,255,255,0.6)' });
      
      try {
        if (mode === 'line') {
          const selectedCodes = getSelectedIndices();
          if (selectedCodes.length === 0) {
            chart.setOption({
              title: { text: 'Please select at least one index', left: 'center' },
              series: []
            });
            updateLegend([]);
            return;
          }

          const results = await Promise.all(selectedCodes.map(c => getLiveData(c, interval, selectedDate)));
          const percentSeries = {};
          
          results.forEach((data, i) => {
            const code = selectedCodes[i];
            if (data.length > 0) {
              const base = data[0].value;
              percentSeries[code] = data.map(d => [d.time, ((d.value - base) / base * 100).toFixed(2)]);
            }
          });
          
          const opt = buildLineOption(percentSeries, selectedDate);
          chart.setOption(opt, true);
          
          const activeIndices = INDEX_DEFS.filter(idx => percentSeries[idx.code]);
          updateLegend(activeIndices);
          
        } else {
          // Candlestick mode
          const code = indexSelect.value;
          const idx = INDEX_DEFS.find(i => i.code === code) || { name: code, color: '#000' };
          
          console.log(`Fetching candlestick data for ${code}`);
          const data = await getLiveData(code, interval, selectedDate);
          console.log(`Received ${data.length} data points for candlestick`);
          
          const opt = buildCandleOption(data, selectedDate);
          chart.setOption(opt, true);
          updateLegend([idx]);
        }
      } catch (e) {
        console.error('Render error:', e);
        updateApiStatus('ðŸ”´ Data loading failed', 'text-red-600');
        chart.setOption({ 
          title: { text: `Error: ${e.message}`, left: 'center', textStyle: { color: '#ef4444' } },
          series: []
        });
      } finally {
        chart.hideLoading();
      }
    }

    // API Connection Test
    async function testApiConnection() {
      const API_BASE = window.location.hostname === 'localhost' 
        ? 'http://localhost:5000'
        : 'https://global-indices-tracker-production.up.railway.app';
      
      try {
        console.log('ðŸ”„ Testing API connection...');
        const response = await fetch(`${API_BASE}/api/health`);
        const data = await response.json();
        
        if (data.status === 'healthy') {
          console.log('âœ… API Connection Success');
          updateApiStatus('ðŸŸ¢ Live data ready', 'text-green-600');
          setTimeout(render, 500);
        } else {
          updateApiStatus('ðŸŸ¡ API issues', 'text-yellow-600');
        }
      } catch (error) {
        console.error('âŒ API Connection Failed:', error);
        updateApiStatus('ðŸ”´ Connection failed', 'text-red-600');
      }
    }

    // Event Listeners
    modeSelect.addEventListener('change', () => { toggleMode(); render(); });
    [intervalSelect, dateSelect].forEach(el => el.addEventListener('change', render));
    refreshBtn.addEventListener('click', render);
    
    document.addEventListener('change', (e) => {
      if (e.target.type === 'checkbox' && e.target.closest('#indexCheckboxes')) {
        render();
      }
    });

    // Initialize
    populateIndexControls();
    toggleMode();
    testApiConnection();
  </script>
</body>
</html>